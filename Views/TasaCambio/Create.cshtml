
@{
    ViewData["Title"] = "Create";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<environment include="Development">
    <link href="~/css/animate.css" rel="stylesheet">
</environment>
<environment exclude="Development">
    <link href="~/css/animate.css" rel="stylesheet">
</environment>

<div class="wrapper">
    <section class="panel animated slideInUp">
        <header class="panel-heading">
            Cambio oficial
        </header>
        <div class="panel-body">
            <div class="col-lg-12">
                <div class="form-group col-lg-2">                    
                    <label for="anio" class="control-label col-lg-5">Año</label>
                    <select class="form-control col-lg-7" id="anio">
                        @foreach (var anio in ViewBag.anios)
                        {
                            <option value="@anio">@anio</option>
                        }
                    </select>
                </div>
                <div class="form-group col-lg-2">
                    <label class="control-label col-lg-5">Mes</label>
                    <select class="form-control col-lg-7" id="mes">
                        <option value='1'>Enero</option>
                        <option value='2'>Febrero</option>
                        <option value='3'>Marzo</option>
                        <option value='4'>Abril</option>
                        <option value='5'>Mayo</option>
                        <option value='6'>Junio</option>
                        <option value='7'>Julio</option>
                        <option value='8'>Agosto</option>
                        <option value='9'>Septiembre</option>
                        <option value='10'>Octubre</option>
                        <option value='11'>Noviembre</option>
                        <option value='12'>Diciembre</option>
                    </select>

                </div>
                <div class="form-group col-lg-3">   
                    <div class="padding-top22">
                        <button id="btnSearch" type="button" class="btn btn-primary"><span class="fa fa-search"></span> Buscar</button>
                        <button id="btnSave" type="button" onclick="save();" disabled="disabled" class="btn btn-success"><span class="fa fa-save"></span> Guardar</button>
                    </div>                    
                </div>
            </div>
            <div class="col-lg-12">
                <div id="tasaCambio"></div>
                @*<table id="tasaCambio" class="table table-hover"></table>*@
            </div>
        </div>
    </section>
</div>
@section Scripts
    {
    <environment include="Development">
        <script src="~/js/site.js"></script>
        <script src="~/js/notify.js"></script>
    </environment>
    <environment exclude="Development">
        <script src="~/js/site.js"></script>
        <script src="~/js/notify.js"></script>
    </environment>
    <script>
        $('#btnSearch').click(function () {
            $('#btnSearch').html('<span class="fa fa-spinner fa-pulse"></span> Buscando...');
            $.get(pathBase + "TasaCambio/obtenerCambioOficial", { anio: $('#anio').val(), mes: $('#mes').val() }, function (data) {
                $('#tasaCambio').html(data);
                $('#btnSearch').html('<span class="fa fa-search"></span> Buscar</span>');
                if (data.length) {
                    $('#btnSave').removeAttr('disabled');
                }
            });
        });  

      

        var save = () => {
            var tabla = $('#tasaCambio tbody tr');
            $('#btnSave').html('<span class="fa fa-spinner fa-pulse"></span> Guardando...');
            $.get(pathBase + "TasaCambio/guardar",
                { anio: $('#anio').val(), mes: $('#mes').val() },
                function (data) {                  
                    
                    tabla.each(function (i, e) {
                        var actual = data.find(x => x.fecha == $(this).find("td:eq(1)").text())
                        if (actual.udpated) {
                            $(this).find("td:eq(1)").html(actual.fecha + '<span class="fa fa-plus text-success"></span>');
                        } else {
                            $(this).find("td:eq(1)").html(actual.fecha + '<span class="fa fa-check text-primary"></span>');
                        }
                    });
                    $('#btnSave').html('<span class="fa fa-save"></span> Guardar</span>');

                    $.notification(`Datos guardados correctamente...
                    ${data.filter(d => d.udpated).length} ingresados 
                    ${data.filter(d => !d.udpated).length} actualizados`, 'success');
            });
        }
    </script>
    }
